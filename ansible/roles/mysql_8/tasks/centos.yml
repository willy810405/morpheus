---
- name: Install required packages
  dnf:
    name: ["mysql-server", "python3-PyMySQL"]
    state: present

- name: Start and enable mysqld
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Get temporary MySQL root password (may fail if not initial install)
  shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  failed_when: false
  changed_when: false

- name: Set MySQL root password (initial or re-apply)
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_password: "{{ mysql_temp_password.stdout | default(mysql_root_password) }}"
    check_implicit_admin: true
    priv: "*.*:ALL,GRANT"
    state: present

