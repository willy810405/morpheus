---
- name: Install CentOS Stream official repos
  dnf:
    name: centos-stream-repos
    state: present

- name: Replace BaseOS baseurl with NCHC mirror
  replace:
    path: /etc/yum.repos.d/CentOS-Stream-BaseOS.repo
    regexp: '^baseurl=.*'
    replace: 'baseurl=https://free.nchc.org.tw/centos-stream/9-stream/BaseOS/$basearch/os/'

- name: Replace AppStream baseurl with NCHC mirror
  replace:
    path: /etc/yum.repos.d/CentOS-Stream-AppStream.repo
    regexp: '^baseurl=.*'
    replace: 'baseurl=https://free.nchc.org.tw/centos-stream/9-stream/AppStream/$basearch/os/'

- name: Disable mirrorlist in BaseOS repo
  replace:
    path: /etc/yum.repos.d/CentOS-Stream-BaseOS.repo
    regexp: '^mirrorlist=.*'
    replace: '#mirrorlist disabled'

- name: Disable mirrorlist in AppStream repo
  replace:
    path: /etc/yum.repos.d/CentOS-Stream-AppStream.repo
    regexp: '^mirrorlist=.*'
    replace: '#mirrorlist disabled'

- name: Rebuild yum cache
  shell: |
    dnf clean all
    dnf makecache

- name: Install required packages
  dnf:
    name: ["mysql-server", "python3-PyMySQL"]
    state: present

- name: Start and enable mysqld
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Get temporary MySQL root password (may fail if not initial install)
  shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  failed_when: false
  changed_when: false

- name: Set MySQL root password (initial or re-apply)
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_password: "{{ mysql_temp_password.stdout | default(mysql_root_password) }}"
    check_implicit_admin: true
    priv: "*.*:ALL,GRANT"
    state: present
