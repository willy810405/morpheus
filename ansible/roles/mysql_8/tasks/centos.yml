---
- name: Backup original yum repo
  copy:
    src: /etc/yum.repos.d/
    dest: /etc/yum.repos.d.bak/
    remote_src: yes
    mode: preserve

- name: Replace CentOS 9 Stream repo with NCHC Taiwan mirror
  get_url:
    url: https://free.nchc.org.tw/centos-stream/9-stream/BaseOS/x86_64/os/
    dest: /etc/yum.repos.d/CentOS-Stream.repo
    mode: '0644'

- name: Clean and rebuild yum cache
  shell: |
    dnf clean all
    dnf makecache

- name: Install required packages
  dnf:
    name: ["mysql-server", "python3-PyMySQL"]
    state: present

- name: Start and enable mysqld
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Get temporary MySQL root password (may fail if not initial install)
  shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  failed_when: false
  changed_when: false

- name: Set MySQL root password (initial or re-apply)
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_password: "{{ mysql_temp_password.stdout | default(mysql_root_password) }}"
    check_implicit_admin: true
    priv: "*.*:ALL,GRANT"
    state: present
