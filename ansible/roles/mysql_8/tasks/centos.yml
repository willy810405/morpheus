---
- name: Backup original yum repo
  copy:
    src: /etc/yum.repos.d/
    dest: /etc/yum.repos.d.bak/
    remote_src: yes
    mode: preserve

- name: Remove invalid CentOS-Stream.repo (if exists)
  file:
    path: /etc/yum.repos.d/CentOS-Stream.repo
    state: absent

- name: Download CentOS Stream 9 repo from NCHC mirror (NTU)
  get_url:
    url: https://raw.githubusercontent.com/ntu-mirrors/centos-mirror/main/CentOS-Stream-9.repo
    dest: /etc/yum.repos.d/CentOS-Stream.repo
    mode: '0644'

- name: Clean and rebuild yum cache
  shell: |
    dnf clean all
    dnf makecache

- name: Install required packages
  dnf:
    name: ["mysql-server", "python3-PyMySQL"]
    state: present

- name: Start and enable mysqld
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Get temporary MySQL root password (may fail if not initial install)
  shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  failed_when: false
  changed_when: false

- name: Set MySQL root password (initial or re-apply)
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    login_password: "{{ mysql_temp_password.stdout | default(mysql_root_password) }}"
    check_implicit_admin: true
    priv: "*.*:ALL,GRANT"
    state: present

